---
phase: 05-rag-tracker-and-formula-sheets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/js/tracker.js
  - assets/css/styles.css
  - foundation/index.html
  - core/index.html
  - additional/index.html
  - foundation/fractions/index.html
  - foundation/division/index.html
  - foundation/prime-factors/index.html
  - foundation/estimation/index.html
  - foundation/long-multiplication/index.html
  - foundation/averages/index.html
  - core/ratio/index.html
  - core/percentages/index.html
  - core/algebra-basics/index.html
  - core/shape/index.html
  - core/averages/index.html
  - core/angles/index.html
  - core/probability/index.html
  - core/coordinates-graphs/index.html
  - core/transformations/index.html
  - core/volume-surface-area/index.html
  - core/sequences-nth-term/index.html
  - core/straight-line-graphs/index.html
  - core/speed-distance-time/index.html
  - core/powers-roots/index.html
  - core/charts-data/index.html
  - additional/index-laws/index.html
  - additional/expanding-factorising/index.html
  - additional/pythagoras/index.html
autonomous: true
requirements:
  - RAG-01
  - RAG-02
  - RAG-03
  - RAG-04
  - RAG-05

must_haves:
  truths:
    - "Pupil can click a Red, Amber, or Green button on any topic page and the active button is visually highlighted"
    - "Pupil's RAG rating is still present after closing the tab and reopening the same topic page"
    - "The 3 level index pages show a coloured dot beside each topic whose rating has been set"
    - "Pupil using Safari private browsing sees a yellow warning banner instead of a crash"
    - "localStorage key used is exactly 'maths-revision:tracker' (no other key pollutes the namespace)"
  artifacts:
    - path: "assets/js/tracker.js"
      provides: "RAG localStorage module: isStorageAvailable(), load(), save(), setRating(), getRating(), reset(), window.tracker public API"
      min_lines: 60
    - path: "assets/css/styles.css"
      provides: "RAG CSS: .rag-selector, .rag-btn, .rag-btn.rag-active, .rag-index-badge, .rag-unavailable, print hide rules"
      contains: ".rag-selector"
    - path: "foundation/fractions/index.html"
      provides: "Representative topic page with RAG selector markup and inline JS wiring"
      contains: "data-topic-slug"
    - path: "foundation/index.html"
      provides: "Representative level index with data-topic-slug on each li and inline JS for badge injection"
      contains: "data-topic-slug"
  key_links:
    - from: "all 24 topic pages (.rag-selector[data-topic-slug])"
      to: "window.tracker.setRating() / getRating()"
      via: "inline DOMContentLoaded script reading sel.dataset.topicSlug"
      pattern: "data-topic-slug"
    - from: "all 3 index pages (.topic-list li[data-topic-slug])"
      to: "window.tracker.getRating(slug)"
      via: "inline DOMContentLoaded script injecting .rag-index-badge"
      pattern: "rag-index-badge"
    - from: "tracker.js"
      to: "localStorage key 'maths-revision:tracker'"
      via: "JSON.stringify / JSON.parse on single namespaced key"
      pattern: "maths-revision:tracker"
---

<objective>
Create the RAG confidence tracker module and wire it to all 27 HTML pages (24 topic pages + 3 level index pages).

Purpose: Pupils can self-assess their confidence on every topic as Red/Amber/Green, and their ratings persist across browser sessions. Level index pages show a coloured dot per topic at a glance.

Output: assets/js/tracker.js (new), updated assets/css/styles.css (RAG CSS added), all 27 HTML files updated with tracker.js script tag + RAG UI markup.
</objective>

<execution_context>
@/Users/josh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/josh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/josh/projects/maths-revision/.planning/PROJECT.md
@/Users/josh/projects/maths-revision/.planning/ROADMAP.md
@/Users/josh/projects/maths-revision/.planning/STATE.md

<!-- Representative pages to understand current HTML structure before editing -->
@/Users/josh/projects/maths-revision/foundation/fractions/index.html
@/Users/josh/projects/maths-revision/foundation/index.html
@/Users/josh/projects/maths-revision/core/index.html
@/Users/josh/projects/maths-revision/additional/index.html
@/Users/josh/projects/maths-revision/assets/css/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tracker.js and add RAG CSS to styles.css</name>
  <files>
    assets/js/tracker.js
    assets/css/styles.css
  </files>
  <action>
Create /Users/josh/projects/maths-revision/assets/js/tracker.js as a self-contained IIFE (no ES modules — GitHub Pages serves static files with no bundler). The module must:

1. Define isStorageAvailable() using a try/catch write-test (NOT typeof check — insufficient for Safari private mode):
   ```
   function isStorageAvailable() {
     try {
       var test = '__maths-revision-test__';
       localStorage.setItem(test, '1');
       localStorage.removeItem(test);
       return true;
     } catch (e) { return false; }
   }
   ```

2. Set `var available = isStorageAvailable()` at module level.

3. Implement readAll() — returns JSON.parse of localStorage.getItem('maths-revision:tracker') or {} if unavailable/throws/null.

4. Implement writeAll(data) — JSON.stringify to localStorage.setItem('maths-revision:tracker', ...). Silently catch quota errors.

5. Expose window.tracker with:
   - available: boolean
   - getRating(slug) — returns readAll()[slug] || null
   - setRating(slug, rating) — updates JSON object, calls writeAll. If rating===null, delete the key.
   - reset() — localStorage.removeItem('maths-revision:tracker') inside try/catch

Use 'use strict' inside the IIFE. Use var (not const/let) for broadest compatibility — school iPads may run old Safari.

CRITICAL: localStorage key must be exactly 'maths-revision:tracker' — this is namespaced to prevent collision with the French revision site on the same GitHub Pages origin.

---

Append to /Users/josh/projects/maths-revision/assets/css/styles.css (after the existing content, before any @media blocks if present, or at end of file):

Add a clearly marked `/* ─── RAG TRACKER ─── */` section with:

- .rag-selector: display flex, align-items center, gap 0.5rem, margin 1rem 0 1.5rem, flex-wrap wrap
- .rag-label: font-size 0.9rem, font-weight 600, color var(--text-mid), margin-right 0.25rem
- .rag-btn: border 2px solid transparent, border-radius 6px, padding 0.35rem 0.9rem, font-family Dosis, font-size 0.9rem, font-weight 600, cursor pointer, opacity 0.45 (unselected/dimmed state), color white, transition opacity 0.1s
- .rag-btn.rag-red: background #dc2626
- .rag-btn.rag-amber: background #d97706
- .rag-btn.rag-green: background #16a34a
- .rag-btn.rag-active: opacity 1, border-color rgba(0,0,0,0.25), box-shadow 0 0 0 3px rgba(0,0,0,0.1)
- .rag-index-badge: display inline-block, width 10px, height 10px, border-radius 50%, margin-left 0.5rem, vertical-align middle
- .rag-index-badge.rag-red/amber/green: matching background colours
- .rag-unavailable: font-size 0.85rem, color var(--text-muted), padding 0.5rem 0.75rem, background #fef9c3, border 1px solid #fde047, border-radius 6px, margin 0.5rem 0 1.5rem

Add a `@media print { .rag-selector, .rag-unavailable { display: none !important; } }` rule (formula sheet print CSS will be added in plan 05-02 — just the RAG print hide rule here).
  </action>
  <verify>
    <automated>node -e "const fs = require('fs'); const t = fs.readFileSync('/Users/josh/projects/maths-revision/assets/js/tracker.js','utf8'); console.assert(t.includes('maths-revision:tracker'), 'namespace missing'); console.assert(t.includes('isStorageAvailable'), 'availability check missing'); console.assert(t.includes('window.tracker'), 'public API missing'); console.assert(t.includes('getRating'), 'getRating missing'); console.assert(t.includes('setRating'), 'setRating missing'); console.assert(t.includes('reset'), 'reset missing'); const css = fs.readFileSync('/Users/josh/projects/maths-revision/assets/css/styles.css','utf8'); console.assert(css.includes('.rag-selector'), 'RAG CSS missing'); console.assert(css.includes('#dc2626'), 'red colour missing'); console.assert(css.includes('#d97706'), 'amber colour missing'); console.assert(css.includes('#16a34a'), 'green colour missing'); console.assert(css.includes('.rag-index-badge'), 'badge CSS missing'); console.log('Task 1 assertions passed');"</automated>
    <manual>Open browser devtools console and verify no syntax errors in tracker.js by loading: file:///Users/josh/projects/maths-revision/foundation/fractions/index.html (after Task 2 wires it)</manual>
  </verify>
  <done>
    - assets/js/tracker.js exists, ~60+ lines, IIFE with 'use strict', window.tracker exposed with available/getRating/setRating/reset
    - Key is exactly 'maths-revision:tracker'
    - isStorageAvailable() uses write-test pattern
    - RAG CSS section exists in styles.css with all button/badge/unavailable rules and red #dc2626, amber #d97706, green #16a34a colours
    - @media print hides .rag-selector and .rag-unavailable
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire tracker.js to all 24 topic pages</name>
  <files>
    foundation/fractions/index.html
    foundation/division/index.html
    foundation/prime-factors/index.html
    foundation/estimation/index.html
    foundation/long-multiplication/index.html
    foundation/averages/index.html
    core/ratio/index.html
    core/percentages/index.html
    core/algebra-basics/index.html
    core/shape/index.html
    core/averages/index.html
    core/angles/index.html
    core/probability/index.html
    core/coordinates-graphs/index.html
    core/transformations/index.html
    core/volume-surface-area/index.html
    core/sequences-nth-term/index.html
    core/straight-line-graphs/index.html
    core/speed-distance-time/index.html
    core/powers-roots/index.html
    core/charts-data/index.html
    additional/index-laws/index.html
    additional/expanding-factorising/index.html
    additional/pythagoras/index.html
  </files>
  <action>
For ALL 24 topic pages, make two additions:

**Addition 1 — script tag in `<head>`** (after the existing styles.css link tag):
```html
<script defer src="/MathsRevisionSite/assets/js/tracker.js"></script>
```

**Addition 2 — RAG selector markup in `<main>`** (insert after the `<h1 class="page-title">` element and before the first `<h2>` or `<p class="non-calc-badge">`). For Foundation pages the non-calc-badge line exists — insert the RAG block AFTER the non-calc-badge line:
```html
<!-- RAG Confidence Tracker -->
<div class="rag-selector" data-topic-slug="SLUG_HERE">
  <span class="rag-label">How confident are you?</span>
  <button class="rag-btn rag-red"   data-rating="red">Not sure</button>
  <button class="rag-btn rag-amber" data-rating="amber">Getting there</button>
  <button class="rag-btn rag-green" data-rating="green">Got it</button>
</div>
<div class="rag-unavailable" style="display:none">
  Confidence tracker not available in private browsing.
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  var sel = document.querySelector('.rag-selector');
  if (!sel) return;
  var slug = sel.dataset.topicSlug;
  if (!window.tracker || !window.tracker.available) {
    var msg = document.querySelector('.rag-unavailable');
    if (msg) msg.style.display = '';
    sel.style.display = 'none';
    return;
  }
  function applyRating(rating) {
    sel.querySelectorAll('.rag-btn').forEach(function (btn) {
      btn.classList.toggle('rag-active', btn.dataset.rating === rating);
    });
  }
  applyRating(window.tracker.getRating(slug));
  sel.addEventListener('click', function (e) {
    var btn = e.target.closest('.rag-btn');
    if (!btn) return;
    window.tracker.setRating(slug, btn.dataset.rating);
    applyRating(btn.dataset.rating);
  });
});
</script>
```

Use EXACTLY these slugs for `data-topic-slug` (verbatim — these are locked from Phase 1):
- foundation/fractions/index.html → `foundation/fractions`
- foundation/division/index.html → `foundation/division`
- foundation/prime-factors/index.html → `foundation/prime-factors`
- foundation/estimation/index.html → `foundation/estimation`
- foundation/long-multiplication/index.html → `foundation/long-multiplication`
- foundation/averages/index.html → `foundation/averages`
- core/ratio/index.html → `core/ratio`
- core/percentages/index.html → `core/percentages`
- core/algebra-basics/index.html → `core/algebra-basics`
- core/shape/index.html → `core/shape`
- core/averages/index.html → `core/averages`
- core/angles/index.html → `core/angles`
- core/probability/index.html → `core/probability`
- core/coordinates-graphs/index.html → `core/coordinates-graphs`
- core/transformations/index.html → `core/transformations`
- core/volume-surface-area/index.html → `core/volume-surface-area`
- core/sequences-nth-term/index.html → `core/sequences-nth-term`
- core/straight-line-graphs/index.html → `core/straight-line-graphs`
- core/speed-distance-time/index.html → `core/speed-distance-time`
- core/powers-roots/index.html → `core/powers-roots`
- core/charts-data/index.html → `core/charts-data`
- additional/index-laws/index.html → `additional/index-laws`
- additional/expanding-factorising/index.html → `additional/expanding-factorising`
- additional/pythagoras/index.html → `additional/pythagoras`

Do NOT use var/const/let confusion — use var throughout the inline script for consistency with tracker.js.
Do NOT add a reset button — tracker.reset() exists in code but is omitted from UI in v1 per spec.
  </action>
  <verify>
    <automated>node -e "
const fs = require('fs');
const slugs = [
  ['foundation/fractions', 'foundation/fractions/index.html'],
  ['foundation/division', 'foundation/division/index.html'],
  ['foundation/prime-factors', 'foundation/prime-factors/index.html'],
  ['foundation/estimation', 'foundation/estimation/index.html'],
  ['foundation/long-multiplication', 'foundation/long-multiplication/index.html'],
  ['foundation/averages', 'foundation/averages/index.html'],
  ['core/ratio', 'core/ratio/index.html'],
  ['core/percentages', 'core/percentages/index.html'],
  ['core/algebra-basics', 'core/algebra-basics/index.html'],
  ['core/shape', 'core/shape/index.html'],
  ['core/averages', 'core/averages/index.html'],
  ['core/angles', 'core/angles/index.html'],
  ['core/probability', 'core/probability/index.html'],
  ['core/coordinates-graphs', 'core/coordinates-graphs/index.html'],
  ['core/transformations', 'core/transformations/index.html'],
  ['core/volume-surface-area', 'core/volume-surface-area/index.html'],
  ['core/sequences-nth-term', 'core/sequences-nth-term/index.html'],
  ['core/straight-line-graphs', 'core/straight-line-graphs/index.html'],
  ['core/speed-distance-time', 'core/speed-distance-time/index.html'],
  ['core/powers-roots', 'core/powers-roots/index.html'],
  ['core/charts-data', 'core/charts-data/index.html'],
  ['additional/index-laws', 'additional/index-laws/index.html'],
  ['additional/expanding-factorising', 'additional/expanding-factorising/index.html'],
  ['additional/pythagoras', 'additional/pythagoras/index.html']
];
var errors = [];
slugs.forEach(function(pair) {
  var slug = pair[0], file = pair[1];
  var html = fs.readFileSync('/Users/josh/projects/maths-revision/' + file, 'utf8');
  if (!html.includes('tracker.js')) errors.push(file + ': missing tracker.js script tag');
  if (!html.includes('data-topic-slug=\"' + slug + '\"')) errors.push(file + ': wrong or missing slug, expected ' + slug);
  if (!html.includes('rag-unavailable')) errors.push(file + ': missing rag-unavailable div');
});
if (errors.length) { errors.forEach(function(e) { console.error(e); }); process.exit(1); }
else console.log('All 24 topic pages wired correctly');
"</automated>
  </verify>
  <done>
    - All 24 topic pages have `&lt;script defer src="/MathsRevisionSite/assets/js/tracker.js"&gt;&lt;/script&gt;` in head
    - All 24 pages have .rag-selector with correct data-topic-slug verbatim matching the locked slug list
    - All 24 pages have .rag-unavailable div (hidden by default)
    - All 24 pages have inline DOMContentLoaded script with null-check on sel, availability gate, applyRating(), and click handler
    - No reset button UI on any page
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire tracker.js to the 3 level index pages with RAG badge injection</name>
  <files>
    foundation/index.html
    core/index.html
    additional/index.html
  </files>
  <action>
For each of the 3 level index pages, make two additions:

**Addition 1 — script tag in `<head>`** (after the existing styles.css link tag):
```html
<script defer src="/MathsRevisionSite/assets/js/tracker.js"></script>
```

**Addition 2 — add data-topic-slug to each `<li>` in `.topic-list`** and inject badge script after the `<ul>`.

For foundation/index.html, update each `<li>` to include data-topic-slug:
```html
<li data-topic-slug="foundation/fractions"><a href="/MathsRevisionSite/foundation/fractions/">Fractions</a></li>
<li data-topic-slug="foundation/division"><a href="/MathsRevisionSite/foundation/division/">Division</a></li>
<li data-topic-slug="foundation/prime-factors"><a href="/MathsRevisionSite/foundation/prime-factors/">Prime Factors</a></li>
<li data-topic-slug="foundation/estimation"><a href="/MathsRevisionSite/foundation/estimation/">Estimation</a></li>
<li data-topic-slug="foundation/long-multiplication"><a href="/MathsRevisionSite/foundation/long-multiplication/">Long Multiplication</a></li>
<li data-topic-slug="foundation/averages"><a href="/MathsRevisionSite/foundation/averages/">Averages</a></li>
```

After the closing `</ul>`, add the badge injection script. Use the SAME script block for all 3 index pages:
```html
<script>
document.addEventListener('DOMContentLoaded', function () {
  if (!window.tracker || !window.tracker.available) return;
  document.querySelectorAll('.topic-list li[data-topic-slug]').forEach(function (li) {
    var slug = li.dataset.topicSlug;
    var rating = window.tracker.getRating(slug);
    if (!rating) return;
    var badge = document.createElement('span');
    badge.className = 'rag-index-badge rag-' + rating;
    li.querySelector('a').appendChild(badge);
  });
});
</script>
```

For core/index.html, the 15 topic slugs are:
core/ratio, core/percentages, core/algebra-basics, core/shape, core/averages, core/angles, core/probability, core/coordinates-graphs, core/transformations, core/volume-surface-area, core/sequences-nth-term, core/straight-line-graphs, core/speed-distance-time, core/powers-roots, core/charts-data

For additional/index.html, the 3 topic slugs are:
additional/index-laws, additional/expanding-factorising, additional/pythagoras

The badge injection script is identical across all 3 index pages — do not vary it.

NOTE: Also add a "Formula Sheet" link to each level index page. Add it as a styled link below the topic list `<ul>` (before the badge injection script). Use this pattern for foundation/index.html:
```html
<p class="formula-sheet-link"><a href="/MathsRevisionSite/foundation/formulas/">Foundation Formula Sheet &rsaquo;</a></p>
```
And equivalent for core and additional. This links to pages created in plan 05-02. The pages will not exist until 05-02 executes, but the link is safe to add now.
  </action>
  <verify>
    <automated>node -e "
const fs = require('fs');
var errors = [];
var pages = [
  { file: 'foundation/index.html', slugs: ['foundation/fractions','foundation/division','foundation/prime-factors','foundation/estimation','foundation/long-multiplication','foundation/averages'] },
  { file: 'core/index.html', slugs: ['core/ratio','core/percentages','core/algebra-basics','core/shape','core/averages','core/angles','core/probability','core/coordinates-graphs','core/transformations','core/volume-surface-area','core/sequences-nth-term','core/straight-line-graphs','core/speed-distance-time','core/powers-roots','core/charts-data'] },
  { file: 'additional/index.html', slugs: ['additional/index-laws','additional/expanding-factorising','additional/pythagoras'] }
];
pages.forEach(function(p) {
  var html = fs.readFileSync('/Users/josh/projects/maths-revision/' + p.file, 'utf8');
  if (!html.includes('tracker.js')) errors.push(p.file + ': missing tracker.js');
  if (!html.includes('rag-index-badge')) errors.push(p.file + ': missing badge injection script');
  if (!html.includes('formula-sheet-link')) errors.push(p.file + ': missing formula sheet link');
  p.slugs.forEach(function(slug) {
    if (!html.includes('data-topic-slug=\"' + slug + '\"')) errors.push(p.file + ': missing slug ' + slug);
  });
});
if (errors.length) { errors.forEach(function(e) { console.error(e); }); process.exit(1); }
else console.log('All 3 index pages wired correctly');
"</automated>
  </verify>
  <done>
    - All 3 level index pages have tracker.js script tag in head
    - Every `&lt;li&gt;` in .topic-list has correct data-topic-slug attribute matching locked slug list
    - Badge injection script present after `&lt;/ul&gt;` — guards on tracker.available before running
    - Formula sheet link present (links to /level/formulas/ which 05-02 will create)
    - Core index has all 15 slugs, Foundation has 6, Additional has 3
  </done>
</task>

</tasks>

<verification>
All 3 tasks complete when:
- `node -e` assertions in Task 1 verify pass (tracker.js content + CSS content)
- `node -e` assertions in Task 2 verify pass (all 24 topic pages have correct slugs + script tags)
- `node -e` assertions in Task 3 verify pass (all 3 index pages have slugs + badge script + formula link)

Manual smoke test (optional but recommended):
1. Open foundation/fractions/index.html in a browser
2. Click "Got it" (green button) — it should become fully opaque with a shadow
3. Navigate to foundation/index.html — a green dot should appear next to "Fractions"
4. Close and reopen the fractions page — green button should still be active
</verification>

<success_criteria>
- RAG-01: Red/Amber/Green buttons visible on all 24 topic pages with active state styling
- RAG-02: Ratings survive browser close/reopen (localStorage JSON object under 'maths-revision:tracker')
- RAG-03: Coloured dot badges appear on level index pages for rated topics
- RAG-04: .rag-unavailable banner shown when tracker.available is false; no JS crash
- RAG-05: Single key 'maths-revision:tracker' used — no other localStorage keys created by tracker.js
</success_criteria>

<output>
After completion, create `/Users/josh/projects/maths-revision/.planning/phases/05-rag-tracker-and-formula-sheets/05-01-SUMMARY.md`
</output>
