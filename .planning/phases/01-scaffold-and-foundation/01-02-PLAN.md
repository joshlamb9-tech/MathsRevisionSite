---
phase: 01-scaffold-and-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - index.html
  - assets/css/styles.css
  - katex-test/index.html
autonomous: false
requirements:
  - INFRA-02
  - INFRA-03
  - INFRA-05

must_haves:
  truths:
    - "A test equation renders on the live GitHub Pages URL — not as raw LaTeX or blank space"
    - "Both inline ($...$) and display ($$...$$) equations render correctly"
    - "Display equations scroll horizontally on narrow screens instead of overflowing"
    - "f'(x) prime notation renders on the live GitHub Pages URL (Jekyll not mangling it)"
    - "KaTeX scripts use defer — no raw LaTeX flash on cold page load"
  artifacts:
    - path: "katex-test/index.html"
      provides: "Dedicated KaTeX test page with inline, display, and prime notation equations"
      contains: "renderMathInElement"
    - path: "assets/css/styles.css"
      provides: "KaTeX mobile overflow fix (.katex-display overflow-x: auto)"
      contains: ".katex-display"
  key_links:
    - from: "katex-test/index.html"
      to: "https://cdn.jsdelivr.net/npm/katex@0.16.33/dist/katex.min.js"
      via: "defer script tag with SRI integrity hash"
      pattern: "defer.*katex@0.16.33.*katex.min.js"
    - from: "katex-test/index.html"
      to: "renderMathInElement"
      via: "onload callback on auto-render script"
      pattern: "onload=\"renderMathInElement"
    - from: "assets/css/styles.css"
      to: ".katex-display"
      via: "CSS rule"
      pattern: "overflow-x: auto"
---

<objective>
Integrate KaTeX 0.16.33 into the site with all four known pitfalls resolved, verify rendering on the live GitHub Pages URL, and add the mobile overflow CSS fix.

Purpose: The four KaTeX pitfalls (defer timing, delimiter order, Jekyll smart quotes, mobile overflow) are cheapest to fix here — before any equations are authored. Fixing after 30+ topic pages exist is expensive. The live URL verification is non-negotiable: the Jekyll/prime-notation bug only manifests on the deployed site, not localhost.

Output: A /katex-test/ page that proves all equation types render correctly on the live GitHub Pages URL. The KaTeX head block template established here becomes the standard for every subsequent topic page.
</objective>

<execution_context>
@/Users/josh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/josh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/01-scaffold-and-foundation/01-RESEARCH.md
@.planning/phases/01-scaffold-and-foundation/01-01-SUMMARY.md

KaTeX version: 0.16.33 (locked)
CDN: jsDelivr (NOT unpkg — reliability issues)
CSS variant: katex-swap.min.css (prevents FOIT — use instead of katex.min.css)

Four pitfalls to address (from 01-RESEARCH.md):
1. Scripts without defer — fix: defer on both scripts, onload callback
2. Delimiter order $$ before $ — fix: list $$ first in delimiters array
3. Jekyll smart quotes — fix: .nojekyll (done in 01-01); verify on live URL
4. Mobile overflow — fix: .katex-display CSS rule in styles.css

Integrity hashes (verified from katex.org official docs, 2026-02-26):
- katex.min.js: sha384-YPHNAPyrxGS8BNnA7Q4ommqra8WQPEjooVSLzFgwgs8OXJBvadbyvx4QpfiFurGr
- auto-render.min.js: sha384-JKXHIJf8PKPyDFptuKZoUyMRQJAmQKj4B4xyOca62ebJhciMYGiDdq/9twUUWyZH
- katex-swap.min.css: SRI hash not confirmed in official docs — omit SRI on the CSS file (stylesheets are lower risk than scripts; acceptable for a school site)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add KaTeX mobile overflow CSS to base stylesheet</name>
  <files>
    assets/css/styles.css
  </files>
  <action>
Add the KaTeX mobile overflow fix to /assets/css/styles.css. This is a global rule that must be in the base stylesheet so it applies to every topic page automatically — not per-page CSS.

Add this rule in the stylesheet after the existing responsive/layout rules:

```css
/* KaTeX display equation overflow fix — applies to all topic pages */
/* Source: KaTeX GitHub issues #327 and #2942 */
.katex-display {
  overflow-x: auto;
  overflow-y: hidden;
  padding: 0.5em 0; /* prevents descender clipping */
}
```

Also add a rule to prevent KaTeX inline equations from contributing to horizontal overflow in tight containers:
```css
.katex {
  font-size: 1.1em; /* slightly larger than body text for readability */
}
```

Add a comment block above these rules:
```css
/* ================================
   KaTeX Equation Rendering
   ================================ */
```

Do NOT change any other rules in styles.css — only append the KaTeX section.
  </action>
  <verify>
    <automated>
      cd /Users/josh/projects/maths-revision &&
      grep -q "katex-display" assets/css/styles.css && echo "PASS: .katex-display rule present" || echo "FAIL: .katex-display missing" &&
      grep -q "overflow-x: auto" assets/css/styles.css && echo "PASS: overflow-x: auto present" || echo "FAIL: overflow fix missing" &&
      grep -q "overflow-y: hidden" assets/css/styles.css && echo "PASS: overflow-y: hidden present" || echo "FAIL: missing"
    </automated>
  </verify>
  <done>
    .katex-display rule exists in styles.css with overflow-x: auto, overflow-y: hidden, padding: 0.5em 0.
    Existing stylesheet rules are unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create KaTeX test page and push to GitHub Pages</name>
  <files>
    katex-test/index.html
  </files>
  <action>
Create /Users/josh/projects/maths-revision/katex-test/index.html — a dedicated KaTeX verification page. This page will be pushed to GitHub Pages and used to confirm all four pitfalls are resolved on the LIVE URL.

The page must test:
1. Inline equation — simple: `The area of a circle is $A = \pi r^2$.`
2. Display (block) equation — `$$x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}$$`
3. Prime notation — `The derivative of $f(x)$ is written as $f'(x)$.` — this SPECIFICALLY tests the Jekyll pitfall
4. Long display equation that overflows on mobile — `$$\frac{d}{dx}\left[\int_{a}^{x} f(t)\,dt\right] = f(x)$$`
5. Nested fractions — `$$\frac{1}{1 + \frac{1}{1 + \frac{1}{x}}}$$`

The HTML structure:

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KaTeX Test | Mowden Hall Maths Revision</title>

  <!-- Dosis font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dosis:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- KaTeX 0.16.33 — swap CSS (FOIT prevention), no SRI on CSS (hash unconfirmed in official docs) -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/katex@0.16.33/dist/katex-swap.min.css"
        crossorigin="anonymous">

  <!-- PITFALL 1 FIX: defer on BOTH scripts. onload callback on auto-render only. -->
  <script defer
          src="https://cdn.jsdelivr.net/npm/katex@0.16.33/dist/katex.min.js"
          integrity="sha384-YPHNAPyrxGS8BNnA7Q4ommqra8WQPEjooVSLzFgwgs8OXJBvadbyvx4QpfiFurGr"
          crossorigin="anonymous"></script>

  <script defer
          src="https://cdn.jsdelivr.net/npm/katex@0.16.33/dist/contrib/auto-render.min.js"
          integrity="sha384-JKXHIJf8PKPyDFptuKZoUyMRQJAmQKj4B4xyOca62ebJhciMYGiDdq/9twUUWyZH"
          crossorigin="anonymous"
          onload="renderMathInElement(document.body, {
            delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
            ]
          });"></script>
  <!-- PITFALL 2 NOTE: $$ listed BEFORE $ — putting $ first would eat $$ as two empty expressions -->

  <link rel="stylesheet" href="/assets/css/styles.css">
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <a href="/" style="display:flex;align-items:center;gap:0.75rem;text-decoration:none">
        <div class="brand-name">Maths Revision</div>
      </a>
      <nav class="header-nav">
        <a href="/" class="hn-link">Home</a>
        <a href="/foundation/" class="hn-link">Foundation</a>
        <a href="/core/" class="hn-link">Core</a>
        <a href="/additional/" class="hn-link">Additional</a>
      </nav>
    </div>
  </header>

  <main class="main-content">
    <p class="breadcrumb"><a href="/">Home</a> › KaTeX Test</p>
    <h1 class="page-title">KaTeX Rendering Test</h1>
    <p style="color:var(--text-muted);margin-bottom:1.5rem">This page verifies all KaTeX equation types render correctly. If any equation shows as raw text (e.g. <code>$A = \pi r^2$</code>), something is broken.</p>

    <section>
      <h2>Test 1: Inline equations</h2>
      <p>The area of a circle is $A = \pi r^2$.</p>
      <p>Pythagoras: $a^2 + b^2 = c^2$.</p>
      <p>Expected: equations render as formatted maths inline with text.</p>
    </section>

    <section>
      <h2>Test 2: Display (block) equations</h2>
      <p>The quadratic formula:</p>
      $$x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}$$
      <p>Expected: centred on its own line, larger than inline.</p>
    </section>

    <section>
      <h2>Test 3: Prime notation (Jekyll pitfall)</h2>
      <p>The derivative of $f(x)$ is written as $f'(x)$.</p>
      <p>On GitHub Pages without .nojekyll, the apostrophe in $f'(x)$ becomes a curly quote and KaTeX throws a parse error. If this renders, .nojekyll is working.</p>
      <p>Also: $g''(x)$ (double prime) and $h'''(x)$ (triple prime).</p>
    </section>

    <section>
      <h2>Test 4: Long equation (mobile overflow test)</h2>
      <p>This equation should scroll horizontally on a narrow screen, not get cut off:</p>
      $$\frac{d}{dx}\left[\int_{a}^{x} f(t)\,dt\right] = f(x) \quad \text{(Fundamental Theorem of Calculus)}$$
      <p>On mobile: scroll right inside the equation box. The page itself should not scroll horizontally.</p>
    </section>

    <section>
      <h2>Test 5: Nested fractions</h2>
      $$\frac{1}{1 + \frac{1}{1 + \frac{1}{x}}}$$
      <p>Expected: three levels of fractions render correctly without overlap.</p>
    </section>

    <section>
      <h2>Test 6: Mixed inline and display</h2>
      <p>When $n$ is a positive integer, the sum of the first $n$ natural numbers is:</p>
      $$S_n = \frac{n(n+1)}{2}$$
      <p>For example, when $n = 10$, we get $S_{10} = \frac{10 \times 11}{2} = 55$.</p>
    </section>
  </main>

  <footer>
    <p>Mowden Hall School · Year 8 CE Maths Revision</p>
  </footer>
</body>
</html>
```

After creating the file, commit everything and push to GitHub to trigger GitHub Pages deployment:

```bash
cd /Users/josh/projects/maths-revision
git add .
git commit -m "feat(01-02): add KaTeX test page and mobile overflow CSS fix"
git push origin main
```

If the remote is not configured yet (this may be the first push), the push will fail — that is expected and will be handled in the checkpoint task below. In that case, commit only (no push) and note in the output that GitHub Pages setup requires the human checkpoint.

Note: The GitHub Pages URL will be in the format `https://[username].github.io/[repo-name]/`. The exact URL is not known at plan time — Josh will provide it during the checkpoint.
  </action>
  <verify>
    <automated>
      cd /Users/josh/projects/maths-revision &&
      test -f katex-test/index.html && echo "PASS: katex-test/index.html exists" || echo "FAIL: missing" &&
      grep -q "defer" katex-test/index.html && echo "PASS: defer present" || echo "FAIL: defer missing" &&
      grep -q "katex-swap.min.css" katex-test/index.html && echo "PASS: swap CSS used" || echo "FAIL: using wrong CSS variant" &&
      grep -q "\"\\$\\$\".*display.*true" katex-test/index.html && echo "PASS: $$ delimiter listed" || echo "FAIL: delimiter config issue" &&
      grep -q "onload=\"renderMathInElement" katex-test/index.html && echo "PASS: onload callback present" || echo "FAIL: onload missing" &&
      grep -q "f'(x)" katex-test/index.html && echo "PASS: prime notation test present" || echo "FAIL: prime test missing" &&
      grep -q "sha384-YPHNAPyrxGS8BNnA7Q4ommqra8WQPEjooVSLzFgwgs8OXJBvadbyvx4QpfiFurGr" katex-test/index.html && echo "PASS: katex.min.js SRI hash correct" || echo "FAIL: wrong or missing SRI hash"
    </automated>
    <manual>Local check: python3 -m http.server 8080, visit http://localhost:8080/katex-test/ — all 6 test sections should show rendered equations, not raw LaTeX strings</manual>
  </verify>
  <done>
    katex-test/index.html exists with all 6 test cases.
    KaTeX scripts use defer with correct SRI hashes.
    Delimiter array has $$ before $.
    onload callback used (not DOMContentLoaded or window.onload).
    katex-swap.min.css used (not katex.min.css).
    File committed to git.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify KaTeX rendering on live GitHub Pages URL</name>
  <files>none — human verification of live URL</files>
  <action>Human verifies all 6 KaTeX test cases pass on the live GitHub Pages URL, including f'(x) prime notation which only fails on the deployed site (not localhost).</action>
  <what-built>
    KaTeX test page at /katex-test/, mobile overflow CSS in base stylesheet. All four pitfalls addressed in code. Needs live GitHub Pages verification for the Jekyll/prime-notation pitfall.
  </what-built>
  <how-to-verify>
    **Step A — Local verification (fast check):**
    1. Run: `cd /Users/josh/projects/maths-revision && python3 -m http.server 8080`
    2. Visit http://localhost:8080/katex-test/
    3. Confirm all 6 test sections show rendered equations (not raw `$...$` text)
    4. On mobile or narrow window (~375px): Test 4 equation should scroll inside its box without the page scrolling

    **Step B — GitHub Pages setup (required for Jekyll/prime test):**
    If the repo does not yet have a GitHub remote, create one:
    1. Go to https://github.com/new
    2. Create repo: suggest `mowden-maths-revision` (public, no README — the code is already there)
    3. Run the git remote commands shown by GitHub after repo creation:
       ```
       git remote add origin https://github.com/[username]/[repo-name].git
       git push -u origin main
       ```
    4. In repo Settings > Pages: Source = "Deploy from a branch", Branch = main, Folder = / (root)
    5. Wait ~60 seconds for first deployment

    **Step C — Live URL verification (critical):**
    1. Visit `https://[username].github.io/[repo-name]/katex-test/`
    2. Confirm Test 3 (prime notation): `$f'(x)$` must render as a formatted equation — NOT throw a KaTeX error
    3. Confirm Test 2 (display equations) render as centred block equations
    4. Open browser console — should be zero KaTeX errors

    **What failure looks like:**
    - Raw text like `$A = \pi r^2$` → defer not working
    - Display equations not centred → delimiter order wrong ($$ must come before $)
    - KaTeX parse error on `f'(x)` → .nojekyll not working (re-check it's at repo root, zero bytes)
    - Equations cut off on mobile → overflow CSS not applied
  </how-to-verify>
  <verify>Human confirms all 6 KaTeX test cases render correctly on the live GitHub Pages URL per the how-to-verify steps above.</verify>
  <done>Josh types "approved" and shares the live GitHub Pages URL.</done>
  <resume-signal>Type "approved" once all 6 tests pass on the live GitHub Pages URL, and share the live URL so it can be recorded in the summary</resume-signal>
</task>

</tasks>

<verification>
- .katex-display rule in assets/css/styles.css with overflow-x: auto, overflow-y: hidden, padding: 0.5em 0
- katex-test/index.html uses katex-swap.min.css (not katex.min.css)
- Both katex.min.js and auto-render.min.js have defer attribute
- auto-render.min.js uses onload callback (not addEventListener)
- Delimiter array: $$ listed before $ (display: true before display: false)
- SRI integrity hash on katex.min.js matches sha384-YPHNAPyrxGS8BNnA7Q4ommqra8WQPEjooVSLzFgwgs8OXJBvadbyvx4QpfiFurGr
- Test 3 (prime notation) passes on live GitHub Pages URL — confirms .nojekyll working
- Zero KaTeX parse errors in browser console on live URL
</verification>

<success_criteria>
- All 6 KaTeX test cases render correctly on the live GitHub Pages URL
- f'(x) prime notation renders (Jekyll disabled)
- Long display equation scrolls horizontally on phone without page overflow
- No raw LaTeX text visible on cold page load (defer working)
- Display equations centred as blocks (delimiter order correct)
- Live GitHub Pages URL recorded and accessible
</success_criteria>

<output>
After completion, create `.planning/phases/01-scaffold-and-foundation/01-02-SUMMARY.md` with:
- Live GitHub Pages URL
- Confirmation each of the 4 pitfalls is resolved (defer, delimiter, .nojekyll, overflow CSS)
- KaTeX head block template (exact HTML to copy into every topic page in Phases 2–4)
- SRI hash status for katex-swap.min.css (confirmed or omitted with reason)
- Any unexpected issues encountered
</output>
